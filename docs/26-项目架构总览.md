# ECE 391 项目架构总览

> 本文档通过图表展示项目的整体架构、模块关系和执行流程。

---

## 一、系统架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           用户空间 (Ring 3)                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐       │
│  │  shell  │  │   ls    │  │   cat   │  │  fish   │  │  hello  │       │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘       │
│       │            │            │            │            │             │
│       └────────────┴────────────┴────────────┴────────────┘             │
│                                  │                                       │
│                          int 0x80 (系统调用)                             │
├──────────────────────────────────┼───────────────────────────────────────┤
│                           内核空间 (Ring 0)                              │
│                                  ▼                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                      系统调用处理层                                 │  │
│  │  syscall_handler.c: execute, halt, read, write, open, close...   │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│       ┌──────────────────────────┼──────────────────────────┐           │
│       │                          │                          │           │
│       ▼                          ▼                          ▼           │
│  ┌──────────┐            ┌──────────────┐            ┌──────────┐      │
│  │ 进程管理  │            │   设备驱动    │            │ 文件系统  │      │
│  │ PCB/调度  │            │ keyboard     │            │ 只读 FS   │      │
│  └──────────┘            │ terminal     │            └──────────┘      │
│       │                  │ rtc          │                  │           │
│       │                  └──────────────┘                  │           │
│       │                          │                          │           │
│       └──────────────────────────┼──────────────────────────┘           │
│                                  │                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                        中断/异常处理层                              │  │
│  │  IDT + 异常处理 + 中断处理 + 8259 PIC                              │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                          内存管理层                                 │  │
│  │  分页系统: 页目录 + 页表 + CR3                                      │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                  │                                       │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │                         硬件抽象层                                  │  │
│  │  x86_desc: GDT + TSS + LDT                                        │  │
│  │  lib: 端口 I/O + 字符串操作 + printf                               │  │
│  └───────────────────────────────────────────────────────────────────┘  │
├──────────────────────────────────────────────────────────────────────────┤
│                              硬件层                                      │
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────────┐       │
│  │ CPU  │  │ 内存  │  │ 键盘  │  │ VGA  │  │ RTC  │  │ PIT定时器 │       │
│  └──────┘  └──────┘  └──────┘  └──────┘  └──────┘  └──────────┘       │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 二、模块依赖关系图

```
                              ┌─────────────┐
                              │   kernel.c  │
                              │  (入口点)    │
                              └──────┬──────┘
                                     │
            ┌────────────────────────┼────────────────────────┐
            │                        │                        │
            ▼                        ▼                        ▼
    ┌──────────────┐        ┌──────────────┐        ┌──────────────┐
    │  idt_init.c  │        │   paging.c   │        │   i8259.c    │
    │  (IDT 初始化) │        │  (分页初始化) │        │ (PIC 初始化)  │
    └──────┬───────┘        └──────────────┘        └──────┬───────┘
           │                                                │
           ▼                                                ▼
    ┌──────────────┐                               ┌──────────────┐
    │ exception_   │                               │  keyboard.c  │
    │ handler.c    │                               │  terminal.c  │
    │ (异常处理)    │                               │  rtc.c       │
    └──────────────┘                               │  pit.c       │
           │                                       │  (设备驱动)   │
           │                                       └──────┬───────┘
           │                                              │
           ▼                                              ▼
    ┌──────────────┐                               ┌──────────────┐
    │  syscall.S   │◄──────────────────────────────│ file_system.c│
    │  syscall_    │                               │  (文件系统)   │
    │  handler.c   │                               └──────────────┘
    │ (系统调用)    │
    └──────────────┘
           │
           ▼
    ┌──────────────┐
    │   进程管理    │
    │  PCB/调度    │
    └──────────────┘
```

---

## 三、源文件组织结构

```
student-distrib/
│
├── 启动和初始化
│   ├── boot.S              # 汇编入口，从 GRUB 启动
│   ├── kernel.c            # C 语言入口，初始化各子系统
│   ├── x86_desc.S          # GDT/TSS 定义
│   └── x86_desc.h          # 描述符结构定义
│
├── 中断和异常
│   ├── idt_init.c          # IDT 表初始化
│   ├── idt_init.h
│   ├── interrupt_handler.S # 汇编中断入口 (20 个异常)
│   ├── interrupt_handler.h
│   ├── exception_handler.c # C 异常处理函数
│   ├── exception_handler.h
│   ├── i8259.c             # 8259 PIC 驱动
│   └── i8259.h
│
├── 内存管理
│   ├── paging.c            # 分页初始化和管理
│   └── paging.h
│
├── 设备驱动
│   ├── keyboard.c          # PS/2 键盘驱动
│   ├── keyboard.h
│   ├── terminal.c          # VGA 文本终端驱动
│   ├── terminal.h
│   ├── rtc_handler.c       # RTC 实时时钟驱动
│   ├── rtc_handler.h
│   ├── pit.c               # PIT 定时器 + 调度器
│   └── pit.h
│
├── 文件系统
│   ├── file_system.c       # 只读文件系统
│   └── file_system.h
│
├── 系统调用和进程
│   ├── syscall.S           # 系统调用汇编入口
│   ├── syscall.h           # 系统调用号定义
│   ├── syscall_handler.c   # 系统调用实现
│   ├── syscall_handler.h
│   └── global.h            # PCB/FD 等全局定义
│
├── 工具库
│   ├── lib.c               # printf, memcpy, 端口 I/O
│   ├── lib.h
│   └── types.h             # 类型定义
│
├── 调试和测试
│   ├── tests.c             # 测试用例
│   ├── tests.h
│   └── debug.h             # 调试宏
│
└── 编译
    └── Makefile
```

---

## 四、系统启动流程

```
┌─────────────────────────────────────────────────────────────────────┐
│  BIOS/UEFI                                                          │
│    └── 加载 GRUB                                                     │
└────────────────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  GRUB (Multiboot)                                                   │
│    ├── 加载内核镜像 (bootimg)                                        │
│    ├── 加载文件系统镜像 (filesys_img)                                │
│    └── 跳转到 boot.S                                                 │
└────────────────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  boot.S (汇编入口)                                                   │
│    ├── 设置 GDT                                                      │
│    ├── 进入 32 位保护模式                                            │
│    ├── 设置内核栈                                                    │
│    └── 调用 entry() → kernel.c                                       │
└────────────────────────────────────┬────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  kernel.c: entry()                                                  │
│    │                                                                │
│    ├── 1. 初始化 IDT (idt_init)                                     │
│    │       └── 设置 256 个中断描述符                                 │
│    │                                                                │
│    ├── 2. 初始化 PIC (i8259_init)                                   │
│    │       └── 配置主从 8259                                        │
│    │                                                                │
│    ├── 3. 初始化分页 (paging_init)                                   │
│    │       ├── 设置页目录和页表                                      │
│    │       └── 启用分页 (CR0, CR3)                                   │
│    │                                                                │
│    ├── 4. 初始化设备驱动                                             │
│    │       ├── keyboard_init()                                      │
│    │       ├── rtc_init()                                           │
│    │       └── pit_init()                                           │
│    │                                                                │
│    ├── 5. 初始化文件系统 (file_system_init)                          │
│    │       └── 保存文件系统基址                                      │
│    │                                                                │
│    ├── 6. 初始化终端 (terminal_init)                                 │
│    │       └── 清屏，设置光标                                        │
│    │                                                                │
│    ├── 7. 开中断 (sti)                                              │
│    │                                                                │
│    └── 8. 启动 shell (execute("shell"))                             │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Shell 运行                                                         │
│    └── 等待用户输入命令，执行程序                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 五、内存布局图

### 5.1 物理内存布局

```
物理地址
    0MB ┌─────────────────────────────────────┐
        │  BIOS / 中断向量表 / 保留区域         │
        │  (0x00000 - 0x9FFFF)                │
  640KB ├─────────────────────────────────────┤
        │  视频内存 (VGA)                      │
        │  0xA0000 - 0xBFFFF                  │
        │  文本模式: 0xB8000                   │
  768KB ├─────────────────────────────────────┤
        │  BIOS ROM                           │
        │  0xC0000 - 0xFFFFF                  │
    1MB ├─────────────────────────────────────┤
        │  内核代码和数据                       │
        │  加载地址: 0x400000 (4MB)            │
    4MB ├─────────────────────────────────────┤
        │  ████████ 内核 (4MB) ████████       │
        │  代码 + 数据 + BSS                   │
    8MB ├─────────────────────────────────────┤
        │  进程 0 物理内存 (4MB)               │
        │  0x800000 - 0xBFFFFF                │
   12MB ├─────────────────────────────────────┤
        │  进程 1 物理内存 (4MB)               │
        │  0xC00000 - 0xFFFFFF                │
   16MB ├─────────────────────────────────────┤
        │  进程 2 物理内存 (4MB)               │
   20MB ├─────────────────────────────────────┤
        │  进程 3 物理内存 (4MB)               │
   24MB ├─────────────────────────────────────┤
        │  进程 4 物理内存 (4MB)               │
   28MB ├─────────────────────────────────────┤
        │  进程 5 物理内存 (4MB)               │
   32MB └─────────────────────────────────────┘
```

### 5.2 虚拟内存布局（用户进程视角）

```
虚拟地址
    0MB ┌─────────────────────────────────────┐
        │  (未映射)                            │
    4MB ├─────────────────────────────────────┤
        │  内核空间 (4MB 大页)                  │
        │  用户不可访问                        │
    8MB ├─────────────────────────────────────┤
        │  (未映射)                            │
        │                                     │
  128MB ├─────────────────────────────────────┤ 0x08000000
        │  ┌─────────────────────────────┐    │
        │  │      用户程序 (4MB)          │    │
        │  │  加载地址: 0x08048000       │    │
        │  │                             │    │
        │  │  ┌───────────────────────┐  │    │
        │  │  │   代码段 (.text)       │  │    │
        │  │  ├───────────────────────┤  │    │
        │  │  │   数据段 (.data)       │  │    │
        │  │  ├───────────────────────┤  │    │
        │  │  │   BSS 段              │  │    │
        │  │  ├───────────────────────┤  │    │
        │  │  │        ↓ 堆           │  │    │
        │  │  │                       │  │    │
        │  │  │        ↑ 栈           │  │    │
        │  │  │   用户栈顶: 0x8400000  │  │    │
        │  │  └───────────────────────┘  │    │
        │  └─────────────────────────────┘    │
  132MB ├─────────────────────────────────────┤ 0x08400000
        │  (未映射)                            │
  136MB ├─────────────────────────────────────┤ 0x08800000
        │  vidmap 映射区域 (4KB)               │
        │  映射到物理 0xB8000                  │
        └─────────────────────────────────────┘
```

### 5.3 内核栈布局

```
8MB (0x800000)
    │
    ▼
    ┌─────────────────────────────────────┐
    │     进程 0 内核栈 (8KB)              │ 0x7FE000 - 0x800000
    │     ┌─────────────────────────┐     │
    │     │  PCB (栈底)              │     │
    │     ├─────────────────────────┤     │
    │     │                         │     │
    │     │    栈空间 (向下增长)      │     │
    │     │         ↓              │     │
    │     │                         │     │
    │     │  栈顶 (ESP0 指向)        │     │
    │     └─────────────────────────┘     │
    ├─────────────────────────────────────┤
    │     进程 1 内核栈 (8KB)              │ 0x7FC000 - 0x7FE000
    ├─────────────────────────────────────┤
    │     进程 2 内核栈 (8KB)              │ 0x7FA000 - 0x7FC000
    ├─────────────────────────────────────┤
    │     ...                             │
    └─────────────────────────────────────┘

内核栈地址计算:
  进程 N 的内核栈顶 = 8MB - N * 8KB - 4
                   = 0x800000 - N * 0x2000 - 4
```

---

## 六、中断/异常处理流程

### 6.1 异常处理流程

```
┌──────────────────┐
│   CPU 执行指令    │
└────────┬─────────┘
         │
         ▼ 异常发生 (如除零)
┌──────────────────┐
│  CPU 自动操作:    │
│  1. 切换到内核栈  │
│  2. 压入 SS, ESP  │
│  3. 压入 EFLAGS  │
│  4. 压入 CS, EIP │
│  5. 查 IDT 表    │
└────────┬─────────┘
         │
         ▼
┌──────────────────────────────────────────────────────┐
│  interrupt_handler.S: divide_error_wrapper          │
│    pushal          # 保存所有通用寄存器               │
│    call divide_error_handler                        │
│    popal           # 恢复寄存器                      │
│    iret            # 返回                           │
└────────┬─────────────────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────────────────────────┐
│  exception_handler.c: divide_error_handler()        │
│    printf("Divide Error!\n");                       │
│    while(1);  // 停机                               │
└──────────────────────────────────────────────────────┘
```

### 6.2 硬件中断处理流程（键盘为例）

```
┌──────────────┐
│  用户按下键盘  │
└──────┬───────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  键盘控制器产生 IRQ 1                                 │
└──────┬───────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  8259 PIC                                           │
│    └── 向 CPU 发送中断信号 (INT 0x21)                │
└──────┬───────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  CPU                                                │
│    ├── 检查 IF 标志 (中断是否允许)                    │
│    ├── 保存当前状态到栈                              │
│    └── 从 IDT[0x21] 获取处理程序地址                 │
└──────┬───────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  interrupt_handler.S: keyboard_handler_wrapper      │
│    pushal                                           │
│    call keyboard_handler                            │
│    popal                                            │
│    iret                                             │
└──────┬───────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│  keyboard.c: keyboard_handler()                     │
│    1. scancode = inb(0x60)   # 读取扫描码            │
│    2. char c = convert(scancode)                    │
│    3. buffer[index++] = c    # 存入缓冲区            │
│    4. putc(c)                # 回显                 │
│    5. send_eoi(1)            # 发送 EOI             │
└──────────────────────────────────────────────────────┘
```

---

## 七、系统调用流程

```
┌─────────────────────────────────────────────────────────────────────┐
│  用户程序                                                          │
│    │                                                               │
│    │  // 调用 read(fd, buf, nbytes)                                │
│    │  mov eax, 3         # 系统调用号 (SYS_READ)                    │
│    │  mov ebx, fd        # 参数 1                                  │
│    │  mov ecx, buf       # 参数 2                                  │
│    │  mov edx, nbytes    # 参数 3                                  │
│    │  int 0x80           # 触发系统调用                             │
│    │                                                               │
└────┼───────────────────────────────────────────────────────────────┘
     │
     │  ════════════════ 用户态 → 内核态 ════════════════
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  CPU 自动操作:                                                      │
│    1. 从 TSS 加载内核栈指针 (SS0:ESP0)                              │
│    2. 压入用户态 SS, ESP                                            │
│    3. 压入 EFLAGS                                                   │
│    4. 压入用户态 CS, EIP                                            │
│    5. 跳转到 IDT[0x80] 指向的处理程序                                │
└────┬────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  syscall.S: syscall_handler                                        │
│    pushal                    # 保存所有寄存器                        │
│    push edx                  # 参数 3                               │
│    push ecx                  # 参数 2                               │
│    push ebx                  # 参数 1                               │
│    call *syscall_table(,%eax,4)  # 根据 eax 调用对应函数            │
│    add esp, 12               # 清理参数                             │
│    mov [esp+28], eax         # 保存返回值                           │
│    popal                                                           │
│    iret                      # 返回用户态                           │
└────┬────────────────────────────────────────────────────────────────┘
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  syscall_handler.c                                                 │
│                                                                    │
│  syscall_table:                                                    │
│    [0] = NULL                                                      │
│    [1] = halt                                                      │
│    [2] = execute                                                   │
│    [3] = read       ◄──── 调用这个                                  │
│    [4] = write                                                     │
│    [5] = open                                                      │
│    [6] = close                                                     │
│    [7] = getargs                                                   │
│    [8] = vidmap                                                    │
│                                                                    │
│  int32_t read(int32_t fd, void* buf, int32_t nbytes) {            │
│      pcb_t* pcb = get_current_pcb();                              │
│      return pcb->fd_table[fd].fops->read(fd, buf, nbytes);        │
│  }                                                                 │
└────┬────────────────────────────────────────────────────────────────┘
     │
     │  ════════════════ 内核态 → 用户态 ════════════════
     │
     ▼
┌─────────────────────────────────────────────────────────────────────┐
│  用户程序继续执行                                                    │
│    # eax 中包含返回值                                               │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 八、进程生命周期

```
┌─────────────────────────────────────────────────────────────────────┐
│                        进程生命周期                                  │
└─────────────────────────────────────────────────────────────────────┘

                    execute("program")
                           │
                           ▼
┌──────────────────────────────────────────────────────────────────┐
│  1. 创建阶段                                                      │
│     ├── 解析命令 (程序名 + 参数)                                   │
│     ├── 检查可执行文件 (ELF 魔数)                                  │
│     ├── 分配 PID                                                  │
│     ├── 创建 PCB                                                  │
│     │     ├── 初始化文件描述符表                                   │
│     │     │     ├── fd[0] = stdin (terminal)                     │
│     │     │     └── fd[1] = stdout (terminal)                    │
│     │     └── 保存命令行参数                                      │
│     ├── 设置页表 (128MB 虚拟 → 物理)                               │
│     ├── 加载程序到物理内存                                         │
│     └── 设置 TSS (内核栈指针)                                      │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  2. 运行阶段                                                      │
│     ├── IRET 切换到用户态                                         │
│     ├── 程序执行                                                  │
│     │     ├── 系统调用 (read/write/open/close)                   │
│     │     └── 时钟中断 → 可能被调度出去                            │
│     └── 可能执行子进程 (execute)                                   │
└────────────────────────────┬─────────────────────────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────────────┐
│  3. 终止阶段 (halt)                                               │
│     ├── 关闭所有打开的文件                                         │
│     ├── 释放资源                                                  │
│     │     ├── 清除 PCB                                           │
│     │     └── 恢复父进程页表                                      │
│     ├── 恢复父进程上下文                                          │
│     │     ├── 恢复 TSS                                           │
│     │     └── 恢复 ESP/EBP                                       │
│     └── 返回到父进程的 execute() 调用处                            │
└──────────────────────────────────────────────────────────────────┘
```

---

## 九、多终端架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                          多终端架构                                  │
└─────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────────────┐
                    │              键盘输入                    │
                    │         (keyboard_handler)              │
                    └───────────────────┬─────────────────────┘
                                        │
                    ┌───────────────────┴─────────────────────┐
                    │                                         │
         ┌──────────▼──────────┐                   ┌──────────▼──────────┐
         │   普通按键输入        │                   │   Alt+Fx 切换       │
         │   存入当前终端缓冲区   │                   │   switch_terminal() │
         └─────────────────────┘                   └──────────┬──────────┘
                                                              │
┌─────────────────────────────────────────────────────────────┴─────────┐
│                                                                       │
│    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐ │
│    │   Terminal 0    │    │   Terminal 1    │    │   Terminal 2    │ │
│    │                 │    │                 │    │                 │ │
│    │  kb_buffer[128] │    │  kb_buffer[128] │    │  kb_buffer[128] │ │
│    │  cursor_x, y    │    │  cursor_x, y    │    │  cursor_x, y    │ │
│    │  video_backup   │    │  video_backup   │    │  video_backup   │ │
│    │  active_pid     │    │  active_pid     │    │  active_pid     │ │
│    │                 │    │                 │    │                 │ │
│    │  ┌───────────┐  │    │  ┌───────────┐  │    │  ┌───────────┐  │ │
│    │  │  Shell    │  │    │  │  Shell    │  │    │  │  Shell    │  │ │
│    │  │    │      │  │    │  │    │      │  │    │  │    │      │  │ │
│    │  │    ▼      │  │    │  │    ▼      │  │    │  │    ▼      │  │ │
│    │  │  cat      │  │    │  │  ls       │  │    │  │  fish     │  │ │
│    │  └───────────┘  │    │  └───────────┘  │    │  └───────────┘  │ │
│    └─────────────────┘    └─────────────────┘    └─────────────────┘ │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘
                                        │
                                        │ 当前终端
                                        ▼
                    ┌─────────────────────────────────────────┐
                    │           物理视频内存                   │
                    │            0xB8000                      │
                    │         (80x25 文本模式)                 │
                    └─────────────────────────────────────────┘


终端切换流程:
┌─────────────────────────────────────────────────────────────────────┐
│  switch_terminal(old, new):                                        │
│    1. memcpy(terminals[old].video_backup, VIDEO, 4096)  # 保存     │
│    2. terminals[old].cursor_x = screen_x                           │
│    3. terminals[old].cursor_y = screen_y                           │
│    4. memcpy(VIDEO, terminals[new].video_backup, 4096)  # 恢复     │
│    5. screen_x = terminals[new].cursor_x                           │
│    6. screen_y = terminals[new].cursor_y                           │
│    7. update_cursor()                                              │
│    8. current_terminal = new                                       │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 十、调度器流程

```
┌─────────────────────────────────────────────────────────────────────┐
│                        PIT 中断调度                                  │
└─────────────────────────────────────────────────────────────────────┘

    PIT 定时器 (每 10ms 产生一次中断)
                    │
                    ▼
         ┌──────────────────────┐
         │   IRQ 0 中断         │
         └──────────┬───────────┘
                    │
                    ▼
         ┌──────────────────────────────────────────────────┐
         │  pit_handler():                                  │
         │    send_eoi(0);                                  │
         │    schedule();                                   │
         └──────────┬───────────────────────────────────────┘
                    │
                    ▼
         ┌──────────────────────────────────────────────────┐
         │  schedule():                                     │
         │                                                  │
         │    // 1. 保存当前进程上下文                        │
         │    current_pcb->esp = esp;                       │
         │    current_pcb->ebp = ebp;                       │
         │                                                  │
         │    // 2. 选择下一个进程 (Round-Robin)             │
         │    next_pid = current_pid;                       │
         │    do {                                          │
         │        next_pid = (next_pid + 1) % 6;            │
         │    } while (!process_active[next_pid]);          │
         │                                                  │
         │    // 3. 切换页表                                 │
         │    phys_addr = 0x800000 + next_pid * 0x400000;   │
         │    remap_page(0x08000000, phys_addr);            │
         │    flush_tlb();                                  │
         │                                                  │
         │    // 4. 切换 TSS (内核栈)                        │
         │    tss.esp0 = 0x800000 - next_pid * 0x2000 - 4;  │
         │                                                  │
         │    // 5. 恢复新进程上下文                          │
         │    esp = next_pcb->esp;                          │
         │    ebp = next_pcb->ebp;                          │
         │    current_pid = next_pid;                       │
         └──────────────────────────────────────────────────┘


Round-Robin 示例:
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│   时间 →                                                            │
│                                                                     │
│   进程0  ████░░░░░░░░████░░░░░░░░████░░░░░░░░████                   │
│   进程1  ░░░░████░░░░░░░░████░░░░░░░░████░░░░░░░░                   │
│   进程2  ░░░░░░░░████░░░░░░░░████░░░░░░░░████░░░░                   │
│                                                                     │
│   █ = 运行   ░ = 等待                                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 十一、数据结构关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        核心数据结构关系                              │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────┐         ┌──────────────────┐
│     IDT          │         │    Page Dir      │
│  idt[256]        │         │  page_dir[1024]  │
├──────────────────┤         ├──────────────────┤
│ [0] 除零异常      │         │ [0] → 页表        │───────┐
│ [1] 调试异常      │         │ [1] → 4MB 内核页  │       │
│ ...              │         │ [32] → 用户页     │       │
│ [0x21] 键盘中断   │         │ ...              │       │
│ [0x28] RTC 中断   │         └──────────────────┘       │
│ [0x80] 系统调用   │                                    │
└──────────────────┘                                    ▼
                                           ┌──────────────────┐
                                           │   Page Table     │
┌──────────────────┐                       │  page_table[1024]│
│      PCB         │                       ├──────────────────┤
│  (进程控制块)     │                       │ [0xB8] → 视频内存 │
├──────────────────┤                       └──────────────────┘
│ pid              │
│ parent_pid       │
│ esp, ebp         │
│ fd_table[8]  ────┼───────────────────┐
│ args[128]        │                   │
│ active           │                   │
└──────────────────┘                   │
                                       ▼
                          ┌──────────────────────────────┐
                          │     File Descriptor Table    │
                          ├──────────────────────────────┤
                          │ [0] stdin                    │───┐
                          │     fops → terminal_fops     │   │
                          │ [1] stdout                   │───┤
                          │     fops → terminal_fops     │   │
                          │ [2] (可用)                    │   │
                          │ [3] (可用)                    │   │
                          │ ...                          │   │
                          │ [7] (可用)                    │   │
                          └──────────────────────────────┘   │
                                                             │
                                       ┌─────────────────────┘
                                       ▼
                          ┌──────────────────────────────┐
                          │    File Operations Table     │
                          ├──────────────────────────────┤
                          │ terminal_fops:               │
                          │   .open  = terminal_open     │
                          │   .read  = terminal_read     │
                          │   .write = terminal_write    │
                          │   .close = terminal_close    │
                          ├──────────────────────────────┤
                          │ file_fops:                   │
                          │   .open  = file_open         │
                          │   .read  = file_read         │
                          │   .write = file_write (-1)   │
                          │   .close = file_close        │
                          ├──────────────────────────────┤
                          │ rtc_fops:                    │
                          │   .open  = rtc_open          │
                          │   .read  = rtc_read          │
                          │   .write = rtc_write         │
                          │   .close = rtc_close         │
                          └──────────────────────────────┘
```

---

## 十二、Checkpoint 完成情况

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Checkpoint 完成情况                          │
└─────────────────────────────────────────────────────────────────────┘

CP1: 基础设施
├── [✓] IDT 初始化 (idt_init.c)
├── [✓] 异常处理 (exception_handler.c)
├── [✓] 分页系统 (paging.c)
└── [✓] PIC 初始化 (i8259.c)

CP2: 设备驱动
├── [✓] 键盘驱动 (keyboard.c)
├── [✓] 终端驱动 (terminal.c)
├── [✓] RTC 驱动 (rtc_handler.c)
└── [✓] 文件系统 (file_system.c)

CP3: 系统调用
├── [✓] halt
├── [✓] execute
├── [✓] read
├── [✓] write
├── [✓] open
├── [✓] close
├── [✓] getargs
└── [✓] vidmap

CP4: 多终端
├── [✓] 3 个独立终端
├── [✓] Alt+Fx 切换
└── [✓] 视频内存隔离

CP5: 调度器
├── [✓] PIT 定时器
├── [✓] Round-Robin 调度
└── [✓] 多进程并发
```

---

> 本文档提供项目的宏观视图，具体实现细节请参考各模块的深度解析文档。
